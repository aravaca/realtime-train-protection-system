<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TASC Simulator</title>
<!-- Google Fonts: Noto Sans JP Bold -->
  <link href="https://fonts.cdnfonts.com/css/a-otf-shin-go-pro" rel="stylesheet">
<style>

@import url('https://fonts.cdnfonts.com/css/a-otf-shin-go-pro');

html, body {
  margin: 0;
  background: radial-gradient(circle at 50% 20%, #0b0f14, #05070a);
  background-attachment: fixed;
  color: #e7f0ff;
  font-family: 'Orbitron', system-ui, Segoe UI, Roboto, Apple SD Gothic Neo, AppleGothic, sans-serif;
}
.game-background,.snow-background,.rain-background{background:transparent!important}
#wrap{max-width:960px;margin:18px auto;padding:0 12px}
.row{display:flex;gap:12px;align-items:center}
.card{
  background:rgba(18,24,38,.7);border:1px solid rgba(0,246,255,.15);border-radius:16px;padding:16px;
  backdrop-filter:blur(10px);box-shadow:0 8px 24px rgba(0,0,0,.5);transition:transform .2s,box-shadow .2s
}
.card:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(0,0,0,.7)}
canvas{width:100%;height:320px;background:linear-gradient(#0b0f14,#0a1019);border-radius:12px}
.kbd{background:rgba(10,18,28,.8);border:1px solid #2b3f5f;color:#9fc5ff;padding:2px 6px;border-radius:6px;font-size:12px}
.stat{font-size:32px;font-weight:800;color:#fff;text-shadow:0 0 4px rgba(0,200,255,.8)}
.ok{color:#9effb5}.warn{color:#ffd18f}.bad{color:#ff9b9b}
button,.btn-primary{background:linear-gradient(135deg,#00c6ff,#0072ff);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-size:15px;font-weight:600;transition:.3s background,.1s transform}
button:hover,.btn-primary:hover{background:linear-gradient(135deg,#0072ff,#00c6ff);transform:translateY(-1px)}
#overlay{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);
  backdrop-filter:blur(8px);z-index:9999;overflow-y:auto;-webkit-overflow-scrolling:touch
}
#overlay.hide{display:none}
#overlay .card{max-height:90vh;overflow-y:auto}
.title{font-size:1.4rem;font-weight:600;margin-bottom:4px;color:#00f6ff}
.subtitle{font-size:.9rem;color:#9fc5ff;margin-bottom:16px}
.form-label{display:block;font-size:.85rem;margin-bottom:12px;text-align:left;font-weight:500;color:#cceaff}
.form-input{width:100%;box-sizing:border-box;padding:8px 10px;font-size:.9rem;border:1px solid rgba(0,246,255,.3);border-radius:8px;margin-top:4px;background:rgba(10,18,28,.6);color:#e7f0ff}
.form-input:focus{border-color:#00f6ff;outline:none}
@keyframes snow{0%{transform:translateY(-20px)}100%{transform:translateY(100vh)}}
.snowflakes,.raindrops{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;display:none;overflow:hidden}
.snowflakes div{position:absolute;background:#fff;width:10px;height:10px;border-radius:50%;opacity:.8;animation:snow 5s linear infinite}
.raindrops{z-index:9998}
.raindrops div{position:absolute;background:rgba(173,216,230,.8);width:2px;height:15px;animation:rain .5s linear infinite}
@keyframes rain{0%{transform:translateY(-20px)}100%{transform:translateY(100vh)}}
body{overflow-x:hidden;overflow-y:auto}
@media (max-width:768px){html,body{height:100%}body{-webkit-overflow-scrolling:touch}#wrap{padding-bottom:96px}canvas#hud{height:42vh}}
/* ì¬ì‹œì‘ FAB â€“ ìµœìƒë‹¨, í´ë¦­ í™•ì‹¤í•˜ê²Œ */
.fab{
  position:fixed;left:50%;bottom:24px;transform:translateX(-50%);padding:12px 18px;font-weight:700;border-radius:999px;
  background:linear-gradient(135deg,#00c6ff,#0072ff);color:#fff;border:none;z-index:10001; /* â†‘ ìµœìƒìœ„ */
  box-shadow:0 8px 24px rgba(0,0,0,.35);cursor:pointer;pointer-events:auto
}
.fab.hide{display:none}
.fab:hover{background:linear-gradient(135deg,#0072ff,#00c6ff);transform:translateX(-50%) translateY(-1px)}
.mobile-control-guide{display:none;font-size:14px;color:#9fc5ff;background:rgba(18,24,38,.7);border:1px solid rgba(0,246,255,.2);padding:8px 12px;border-radius:8px;margin-bottom:12px}
@media (max-width:768px){.mobile-control-guide{display:block}}
/* TASC í† ê¸€ â€“ ì‚´ì§ ì•„ë˜ */
.tasc-toggle {
  position: absolute;
  right: 16px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: 'Orbitron', sans-serif;
  z-index: 1001;
  top: 40px; /* ê¸°ë³¸ê°’ = ë°ìŠ¤í¬í†± */
}

/* ëª¨ë°”ì¼ ì „ìš© (í™”ë©´í­ 768px ì´í•˜) */
@media (max-width: 768px) {
  .tasc-toggle {
    top: 165px;
  }
}
.tasc-toggle .tasc-label{font-size:12px;font-weight:600;color:#9fc5ff;user-select:none}
.tasc-toggle input{display:none}
.tasc-toggle .slider{position:relative;display:inline-block;width:46px;height:24px;background:rgba(255,255,255,.25);border-radius:24px;cursor:pointer;transition:background-color .3s;box-shadow:inset 0 0 4px rgba(0,0,0,.3)}
.tasc-toggle .slider::before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.4)}
.tasc-toggle input:checked + .slider{background:linear-gradient(135deg,#00c6ff,#0072ff)}
.tasc-toggle input:checked + .slider::before{transform:translateX(22px)}


.emoji {
  width: 1.4em;
  height: 1.4em;
  vertical-align: middle;
  transition: transform 0.2s;
}
.emoji:hover {
  transform: scale(1.3);
}

.title {
 
  font-size: 1.7em;
  font-family: 'A-OTF Shin Go Pro', sans-serif;
  font-style: normal;
  font-weight: 700;
  color: #0168B7; /* JR-West Blue */
  display: flex;
  align-items: center;
  gap: 8px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ê°„ê²© */
}


</style>
</head>
<body>
<div id="wrap" class="row" style="flex-direction:column">
  <div class="row" style="gap:16px;flex-wrap:wrap">
    <div class="mobile-control-guide">
      ğŸ“± <b>ëª¨ë°”ì¼ ì¡°ì‘ ì•ˆë‚´:</b> ìº”ë²„ìŠ¤(ê·¸ë˜í”„) ìœ„ë¥¼ í„°ì¹˜í•˜ì„¸ìš”.<br>
      ìœ„ìª½ í„°ì¹˜ â†’ ë¸Œë ˆì´í¬ ê°•í™” ğŸ”¼ / ì•„ë˜ìª½ í„°ì¹˜ â†’ ì™„í™” ğŸ”½<br>
ì •ì°¨ í›„ ì•„ë˜ í™”ë©´ì—ì„œ í”¼ë“œë°±ì„ í™•ì¸í•˜ì„¸ìš”.
    </div>

    <div class="card" style="flex:1 1 260px; position: relative">
      <div id="carName" style="font-size:20px; font-family: 'A-OTF Shin Go Pro', sans-serif;
  font-style: normal;" class="stat">ì°¨ëŸ‰ ë¡œë”© ì¤‘...</div>
      <div>ë‚¨ì€ ê±°ë¦¬ <span class="stat" id="rem">â€”</span> m</div>
      <div>ì†ë„ <span class="stat" id="spd">â€”</span> km/h</div>
      <div>ë…¸ì¹˜ <span class="stat" id="notch">0.0</span></div>
      <div>êµ¬ë°° <span class="stat" id="grade_percent">â€”</span> â€°</div>
      <div>ê²½ê³¼ì‹œê°„ <span class="stat" id="timer">0.000</span> s</div>
      <div style="margin-top:8px">ì¡°ì‘: <span class="kbd">Space</span> ì‹œì‘ Â· <span class="kbd">W</span> ê°•í™” Â· <span class="kbd">S</span> ì™„í™” Â· <span class="kbd">N</span> í•´ë°©</div>

<canvas id="brakeLadder"
          style="position:absolute; right:10px; top:12px; width:28px; height:70%;"></canvas>

    </div>

    <div class="card" style="flex:2 1 520px"><canvas id="hud"></canvas></div>
    <div class="card" style="flex:1 1 240px"><div><b>í”¼ë“œë°±</b></div><div id="fb">Spaceë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div></div>
  </div>
</div>

<!-- ì˜¤ë²„ë ˆì´ -->
<div id="overlay">
  <div class="card">
    

  <h2 class="title">
    <img src="./Screenshot_20250815_220422_Brave(1).png" alt="E233" class="emoji"> 
    JR TASC Simulator
  </h2>


    <p class="subtitle">ì´ˆê¸°ê°’ ì…ë ¥ í›„ <b>TASC(ìë™ì •ì°¨)</b> ì„¤ì •í•˜ê³  <b>Space</b> ë˜ëŠ” ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”. TASCê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œë„, ìš´ì „ìëŠ” ìˆ˜ë™ ì¡°ì‘ìœ¼ë¡œ ìš´ì „ì— ê°œì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<!-- TASC -->
    <div class="tasc-toggle">
      <input type="checkbox" id="tascToggle" />
      <label for="tascToggle" class="slider"></label>
      <span class="tasc-label" style="font-weight:700">TASC</span>
    </div>

    <!-- ì „ë™ì°¨ / ì‹œë¦¬ì¦ˆ -->
    <label class="form-label">ì „ë™ì°¨
      <select id="trainFamily" class="form-input">
  <option value="E233" selected>E233ê³„</option>
  <option value="E235">E235ê³„</option>
  <option value="JRW223">223ê³„</option>
  <option value="JRW225">225ê³„</option>
  <option value="JRH261">261ê³„</option>
  <option value="JRW285">285ê³„</option>
  <option value="JRW323">323ê³„</option>
</select>
    </label>
    <label class="form-label">ì‹œë¦¬ì¦ˆ
      <select id="trainSeries" class="form-input"></select>
    </label>

    <label class="form-label">ì´ˆê¸° ì†ë„ (km/h)
      <input id="inputSpeed" type="number" value="70" min="10" max="130" step="1" class="form-input">
    </label>
    <label class="form-label">ê±°ë¦¬ (m)
      <input id="inputDist" type="number" value="300" min="10" max="900" step="1" class="form-input">
    </label>
    <label class="form-label">ê²½ì‚¬ë„ (â€°)
      <input id="inputGrade" type="number" value="0.0" min="-10" max="10" step="0.1" class="form-input">
    </label>

    <label class="form-label">ë‚ ì”¨
      <select id="weatherSelect" class="form-input">
        <option value="ë§‘ìŒ">ë§‘ìŒ</option><option value="ë¹„ì˜´">ë¹„ì˜´</option><option value="ëˆˆì˜´">ëˆˆì˜´</option>
      </select>
    </label>
    <label class="form-label">ìŠ¹ê° íƒ‘ìŠ¹ë¥  (%)
      <input id="inputLoadRate" type="number" value="70" min="0" max="120" step="1" class="form-input">
    </label>

    <!-- í¸ì„± (ì‹œë¦¬ì¦ˆë³„ë¡œë§Œ ê³ ì • ë…¸ì¶œ) -->
    <label class="form-label">í¸ì„±
      <select class="form-input" id="trainLength" onchange="updateTrainLength()"></select>
    </label>

    <div class="game-background"></div>
    <div class="snowflakes"></div>
    <div class="raindrops">
      <div style="animation-delay:0s;left:5%"></div><div style="animation-delay:.2s;left:15%"></div>
      <div style="animation-delay:.4s;left:25%"></div><div style="animation-delay:.6s;left:35%"></div>
      <div style="animation-delay:.8s;left:45%"></div><div style="animation-delay:1s;left:55%"></div>
      <div style="animation-delay:1.2s;left:65%"></div><div style="animation-delay:1.4s;left:75%"></div>
      <div style="animation-delay:1.6s;left:85%"></div><div style="animation-delay:1.8s;left:95%"></div>
    </div>

    <div class="kbd-info"><span class="kbd">W</span> ê°•í™” Â· <span class="kbd">S</span> ì™„í™” Â· <span class="kbd">N</span> í•´ë°©</div>
    <button id="btnStart" class="btn-primary" type="button" style="margin-top:8px">Start (Space)</button>
  </div>
</div>

<!-- ì¬ì‹œì‘ FAB -->
<button id="btnMobileRestart" class="fab hide" type="button">ì¬ì‹œì‘</button>

<script>
/* ===== WebSocket & TASC ===== */
const ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws");
const tascToggle = document.getElementById("tascToggle");
tascToggle.addEventListener("change", () => {
  const enabled = tascToggle.checked;
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "cmd", payload: { name: "setTASC", enabled } }));
  }
});
function forceManualOverride(){
  if (tascToggle.checked){
    tascToggle.checked=false;
    if (ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({type:"cmd",payload:{name:"setTASC",enabled:false}}));
    }
  }
}

/* ===== ë‚ ì”¨ ì´í™íŠ¸ ===== */
const snowflakesContainer=document.querySelector('.snowflakes');
function generateSnowflake(){
  const s=document.createElement('div');
  s.style.animationDelay=(Math.random()*2)+'s';
  s.style.animationDuration=(Math.random()*5+5)+'s';
  s.style.left=Math.floor(Math.random()*101)+'%';
  s.style.position='absolute';s.style.top='-10px';s.style.width='10px';s.style.height='10px';s.style.backgroundColor='rgba(255,255,255,.8)';s.style.borderRadius='50%';
  snowflakesContainer.appendChild(s);
  setTimeout(()=>snowflakesContainer.removeChild(s),7000);
}
setInterval(generateSnowflake,200);


// === Haptics (ëª¨ë°”ì¼ ì „ìš©) ===
// === Haptics (ëª¨ë°”ì¼ ì „ìš©, ê°•ë„ ìƒí–¥ & ê°€ë“œ & ë¡œê¹…) ===
const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

function canVibrate() {
  return isMobile &&
         typeof navigator.vibrate === "function" &&
         document.visibilityState === "visible";
}

function vibrate(pattern) {
  if (!canVibrate()) {
    console.debug("[haptics] blocked: mobile?", isMobile, "api?",
                  typeof navigator.vibrate, "visible?", document.visibilityState);
    return false;
  }
  const ok = navigator.vibrate(pattern);
  // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” boolean, ì¼ë¶€ëŠ” undefinedë¥¼ ë°˜í™˜
  console.debug("[haptics] vibrate called:", pattern, "->", ok);
  return ok !== false;
}

// ê°•í™”/ì™„í™” ì§ˆê°: ì²´ê° ë˜ë„ë¡ ê¸¸ì´ ìƒí–¥
function hapticForNotch(delta) {
  if (delta > 0) {
    // ê°•í™”: ì§§ì€ ì´ì¤‘ íƒ­ (ì²´ê°í˜•)
    vibrate(100);
  } else if (delta < 0) {
    // ì™„í™”: ë‹¨ì¼ ì§§ì€ íƒ­
    vibrate(70);
  }
}

// (ì„ íƒ) EB ì§„ì… ì‹œ ë” ê°•í•œ ì§„ë™
function hapticForEB() {
  vibrate([300, 100, 300]);
}

// (ê¶Œì¥) ì½˜ì†”ì—ì„œ ë°”ë¡œ ì‹œí—˜ ê°€ëŠ¥í•˜ë„ë¡
window.testVibrate = () => vibrate(120);



/* ===== ì°¨ëŸ‰ JSON ë¡œë“œ (ìºì‹œ ë¬´ì‹œ) ===== */
let vehicle=null; let brakeDecels={};
const cacheBust=()=>`?v=${Date.now()}`;
fetch('./e233_0000.json'+cacheBust(),{cache:'no-store'})
  .then(r=>r.json()).then(data=>{
    vehicle=data; document.getElementById('carName').textContent=vehicle.name;
    if(vehicle.notch_accels && vehicle.notches){
      brakeDecels={}; for(let i=0;i<vehicle.notches;i++){ brakeDecels[i]=Math.abs(vehicle.notch_accels[vehicle.notches-1-i]??0); }
    }
  }).catch(console.error);

/* ===== DOM ===== */
const remEl=document.getElementById("rem"), spdEl=document.getElementById("spd"), notchEl=document.getElementById("notch"), fb=document.getElementById("fb");
const overlay=document.getElementById("overlay"), btnStart=document.getElementById("btnStart"), canvas=document.getElementById("hud"), ctx=canvas.getContext("2d");
const weatherSelect=document.getElementById("weatherSelect"), snowflakes=document.querySelector(".snowflakes"), raindrops=document.querySelector(".raindrops");
function resize(){ canvas.width=canvas.clientWidth*devicePixelRatio; canvas.height=canvas.clientHeight*devicePixelRatio; } addEventListener("resize",resize); resize();

function getEbIdx(){
  const acc = (vehicle && Array.isArray(vehicle.notch_accels)) ? vehicle.notch_accels : null;
  const n   = acc ? acc.length
                  : (vehicle && Number.isInteger(vehicle.notches) ? vehicle.notches : 10);
  return Math.max(1, n - 1); // 0:N, 1..EB-1:B..., EB:ë§ˆì§€ë§‰
}

// ê¸°ì¡´
function sendCmd(name, delta){
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({type:"cmd", payload:{name, delta}}));
  }
}




function updateTrainLength(){ const L=document.getElementById("trainLength").value; ws.send(JSON.stringify({type:"cmd",payload:{name:"setTrainLength",length:L}})); sendLoadRate(); }
function sendLoadRate(){
  const loadRate=parseFloat(document.getElementById("inputLoadRate").value)||0;
  const trainLength=parseInt(document.getElementById("trainLength").value)||8;

ws.send(JSON.stringify({
  type: "cmd",
  payload: { 
    name: "setLoadRate", 
    loadRate: loadRate,
    length: trainLength
  }
}));
}
/* ì…ë ¥ ë³´ì • */



const inputSpeed=document.getElementById("inputSpeed"), inputDist=document.getElementById("inputDist"), inputGrade=document.getElementById("inputGrade");
const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
function enforceInt(el,min,max){ el.addEventListener('input',()=>{ el.value=el.value.replace(/[^\d-]/g,'');}); el.addEventListener('change',()=>{let v=parseInt(el.value,10); if(isNaN(v)){el.value='';return;} el.value=String(clamp(v,min,max));});}
function enforceFloat(el,min,max,d=1){ el.addEventListener('input',()=>{ el.value=el.value.replace(/[^0-9.\-]/g,'');}); el.addEventListener('change',()=>{let v=parseFloat(el.value); if(isNaN(v)){el.value='';return;} v=clamp(v,min,max); el.value=v.toFixed(d);});}
enforceInt(inputSpeed,10,130); enforceInt(inputDist,10,900);
const inputLoadRate = document.getElementById("inputLoadRate"); // â† ì¶”ê°€

enforceInt(inputLoadRate,0,120); // â† ì´ì œ ì—ëŸ¬ ì—†ìŒ
document.getElementById("inputLoadRate").addEventListener("change",sendLoadRate); enforceFloat(inputGrade,-10,10,1);

document.getElementById("inputLoadRate").addEventListener("change",sendLoadRate);

/* ë‚ ì”¨ UI */
function muFromWeather(w){return w==="ë¹„ì˜´"?0.6:(w==="ëˆˆì˜´"?0.3:1.0)}
function updateWeatherUI(){
  const w=weatherSelect.value, ov=document.getElementById("overlay");
  if(w==="ëˆˆì˜´"){snowflakes.style.display="block";raindrops.style.display="none";document.documentElement.style.background="#fff";document.body.style.background="#fff";ov.style.background="rgba(255,255,255,.15)";canvas.style.background="#fff";}
  else if(w==="ë¹„ì˜´"){snowflakes.style.display="none";raindrops.style.display="block";document.documentElement.style.background="#4b5d67";document.body.style.background="#4b5d67";ov.style.background="rgba(40,60,80,.35)";canvas.style.background="#4b5d67";}
  else{snowflakes.style.display="none";raindrops.style.display="none";const g="radial-gradient(circle at 50% 20%, #0b0f14, #05070a)";document.documentElement.style.background=g;document.body.style.background=g;ov.style.background="rgba(0,0,0,.6)";canvas.style.background="linear-gradient(#0b0f14,#0a1019)";}
}
weatherSelect.addEventListener("change",()=>{updateWeatherUI();const mu=muFromWeather(weatherSelect.value); if(ws.readyState===WebSocket.OPEN){ws.send(JSON.stringify({type:"cmd",payload:{name:"setMu",value:mu}}));}});
updateWeatherUI();

/* ì‹œì‘/ì¬ì‹œì‘ */
function startRun(){
  inputSpeed.dispatchEvent(new Event('change')); inputDist.dispatchEvent(new Event('change')); inputGrade.dispatchEvent(new Event('change'));
  const speed=Number(inputSpeed.value), dist=Number(inputDist.value), grade=Number(inputGrade.value), mu=muFromWeather(weatherSelect.value);
  if(ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({type:"cmd",payload:{name:"setInitial",speed,dist,grade,mu}})); ws.send(JSON.stringify({type:"cmd",payload:{name:"start"}})); }
  overlay.classList.add("hide"); isFinished=false; overlayShowingResult=false;
  btnMobileRestart.classList.add("hide");
}
btnStart.addEventListener("click", startRun);

const btnMobileRestart=document.getElementById("btnMobileRestart");
btnMobileRestart.addEventListener("click", ()=>{
  // í˜¹ì‹œ ì˜¤ë²„ë ˆì´ê°€ ì´ë¯¸ ë–  ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
  if(!overlay.classList.contains("hide")) overlay.classList.add("hide");
  overlay.classList.remove("hide");
  overlayShowingResult=true;
  btnMobileRestart.classList.add("hide");
});

/* ëª¨ë°”ì¼ í„°ì¹˜ ì¡°ì‘ */
if(/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)){
  const game=document.getElementById("hud");
  game.addEventListener("touchstart",(e)=>{
    if(!overlay.classList.contains("hide")) return;
    if(e.touches.length!==1) return;
    forceManualOverride();
    const r=game.getBoundingClientRect(), y=e.touches[0].clientY-r.top, half=r.height/2;
    if(y<half){
      hapticForNotch(+1);
      sendCmd("applyNotch",+1);
    } else {
      hapticForNotch(-1);
      sendCmd("applyNotch",-1);
 }
}, { passive: true });
}

/* í‚¤ë³´ë“œ */
addEventListener("keydown",(e)=>{
  if([" ","w","W","s","S","n","N"].includes(e.key)) e.preventDefault();
  if(e.repeat) return;
  forceManualOverride();
  if(e.key===" "){ if(ws.readyState!==WebSocket.OPEN) return; startRun(); }
  else if(e.key==="w"||e.key==="W"){ sendCmd("applyNotch",+1); }
  else if(e.key==="s"||e.key==="S"){ sendCmd("applyNotch",-1); }
  else if(e.key==="n"||e.key==="N"){ sendCmd("release",0); }
});

/* HUD & ìƒíƒœ */
const grade_percentEl=document.getElementById("grade_percent"), timerEl=document.getElementById("timer");
let isFinished=false, overlayShowingResult=false, st=null, lastTimestamp=0, prevMaxDistance=0;
function loop(ts){ if(!lastTimestamp) lastTimestamp=ts; lastTimestamp=ts; if(st) drawHUD(st); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

ws.onmessage=(ev)=>{
  const msg=JSON.parse(ev.data);
  if(msg.type==="state"){
    st=msg.payload;
    // === PATCH: ì„œë²„ì—ì„œ ì˜¨ TASC ì˜ˆì¸¡ ì €ì¥ ===
    window.__tasc_pred__ = st.tasc_pred || {};
    const remRaw=st.remaining_m, rem=typeof remRaw==="number"?remRaw:parseFloat(remRaw);
    remEl.textContent = rem>=0 ? rem.toFixed(2) : `-${Math.abs(rem).toFixed(2)}`;
    spdEl.textContent = (st.v*3.6).toFixed(1);
    const maxIdx = (vehicle?.notches ?? 10) - 1; // EB ì¸ë±ìŠ¤
notchEl.textContent =
  st.lever_notch === 0 ? "N" :
  st.lever_notch === maxIdx ? "EB" : `B${st.lever_notch}`;
    grade_percentEl.textContent = (10* st.grade_percent).toFixed(1);
    timerEl.textContent = st.t.toFixed(3);
    drawHUD(st);

    drawBrakeLadderMini(st);  // â† ë¯¸ë‹ˆ ì¸ë””ì¼€ì´í„° ê°±ì‹ 

    if (st.finished) {
      isFinished = true;
      const issues = st.issues || {};

      const feedbackItems = [
        { key: "early_brake_too_short", goodText: "ì´ˆê¸° ì œë™ì„ ìˆ˜í–‰í•¨ - ìŠ¹ì°¨ê° ì–‘í˜¸", badText: "ì´ˆê¸° ì œë™ì„ ê²Œì„ë¦¬í•¨ - ìŠ¹ì°¨ê° ë¶ˆì¾Œ" },
        {
          key: "stop_not_b1",
          goodText: "ì •ì°¨ ì‹œ B1ë¡œ ì •ì°¨í•¨ - ìŠ¹ì°¨ê° ì–‘í˜¸",
          badTextFunc: (issues) => issues.stop_not_b1_msg || "ì •ì°¨ ì‹œ B1ë¡œ ì •ì°¨í•˜ì§€ ì•ŠìŒ",
        },
        {
          key: "step_brake_incomplete",
          goodText: "ê¸°ë³¸ì œë™ (ê³„ë‹¨ì œë™/ì™„í•´) ìˆ˜í–‰í•¨",
          badTextFunc: (issues) => {
            const overrun = issues.stop_error_m !== undefined && issues.stop_error_m <= -2;
            if (issues.stop_error_m !== undefined && issues.stop_error_m <= -2) {
              return "ê¸°ë³¸ì œë™ (ê³„ë‹¨ì œë™/ì™„í•´) ë¯¸í¡ - ì •ì°¨ ìœ„ì¹˜ ì´ˆê³¼ ë° ìš´í–‰ ì§€ì—° ë°œìƒ";
            }
            return "ê¸°ë³¸ì œë™ (ê³„ë‹¨ì œë™/ì™„í•´) ë¯¸í¡ - ë‹¨ì†ì ì¸ ì œë™ìœ¼ë¡œ ì¸í•œ ìŠ¹ê° ì ë¦¼ ë° ì°¨ëŸ‰ ì§„ë™ ë°œìƒ";
          },
        },
        { key: "unnecessary_eb_usage", goodText: "ì˜ì—… ì•ˆì „ ì œë™ë²”ìœ„ ì¤€ìˆ˜", badText: "ë¶ˆí•„ìš”í•œ ë¹„ìƒì œë™(EB) ì‚¬ìš© - ê¸‰ê°ì†ìœ¼ë¡œ ì¸í•œ ì¶©ê²© ë°œìƒ" },
      ];

      const feedbacks = feedbackItems.map(item => {
        const bad = issues[item.key];
        if (!bad) return { text: item.goodText, isGood: true };
        const badText = item.badTextFunc ? item.badTextFunc(issues) : item.badText;
        return { text: badText, isGood: false, isBad: true };
      });

      const isStopErrorGood = Math.abs(st.stop_error_m || 0) <= 2;

      feedbacks.push({
        text: `ì •ì§€ ì˜¤ì°¨: ${st.stop_error_m.toFixed(2)} m`,
        isGood: isStopErrorGood,
      });

      feedbacks.push({
        text: `ìµœì¢… ì ìˆ˜: ${st.score}ì `,
        isGood: isStopErrorGood,
      });

      fb.innerHTML = feedbacks
        .map(item => item.isBad
          ? `<div class="bad">${item.text}</div>`
          : `<div class="${item.isGood ? "ok" : "warn"}">${item.text}</div>`
        )
        .join("") + `<div style="margin-top:8px;font-size:12px;color:#a6b7d1">Spaceë¡œ ë‹¤ì‹œ ì‹œì‘ Â· N í•´ë°© Â· W/Së¡œ ì¡°ì‘</div>`;

      if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) {
        document.getElementById("btnMobileRestart").classList.remove("hide");
      }
    } else {
      isFinished = true;
      fb.textContent = "Spaceë¡œ ì‹œì‘. W/Së¡œ ë¸Œë ˆì´í¬ ì¡°ì ˆí•˜ì„¸ìš”.";
    }
  }
};

/* HUD ê·¸ë¦¬ê¸° (ì›ë³¸ ìœ ì§€) */
function drawHUD(st){
  const dpr=devicePixelRatio||1, w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  const v0=st.v, lever=st.lever_notch, currentPos=st.pos??0, stopPos=st.stopPos??500;
  const remaining=(typeof st.remaining_m==="number")?Math.max(0,st.remaining_m):Math.max(0,stopPos-currentPos);
  const maxDecel=Math.max(...Object.values(brakeDecels)); const maxStop=maxDecel>0?(v0*v0)/(2*maxDecel):0;
  const speedFactor=Math.max(.3,Math.min(1,v0/10)); const adjusted=remaining*(1+(1-speedFactor)*.5);
  const s_b1=(brakeDecels[1]??0)>0?(v0*v0)/(2*brakeDecels[1]):0, s_b2=(brakeDecels[2]??0)>0?(v0*v0)/(2*brakeDecels[2]):0;
  const target=Math.max(1,maxStop*1.5,Math.max(1,Math.sqrt(adjusted)*10)*1.2,s_b1*1.1,s_b2*1.1);
  prevMaxDistance = prevMaxDistance===0 ? target : prevMaxDistance*.9 + target*.1;

  const left=48*dpr, right=12*dpr, usableW=w-left-right, X=d=>left+usableW*(d/prevMaxDistance);
  const vmax=Math.max(1,v0*3.6*1.2);
  const bottom=28*dpr, top=12*dpr, usableH=h-bottom-top, Y=v=>h-bottom-usableH*(v/vmax);

  ctx.strokeStyle="#20334d"; ctx.lineWidth=1*dpr; ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,h-bottom); ctx.lineTo(w-right,h-bottom); ctx.stroke();

  ctx.fillStyle="#888"; ctx.font=`${10*dpr}px sans-serif`; ctx.textAlign="center"; ctx.textBaseline="top";
  for(let d=0; d<=prevMaxDistance; d+=100){ const x=X(d); ctx.beginPath(); ctx.moveTo(x,h-bottom); ctx.lineTo(x,h-bottom+4*dpr); ctx.stroke(); ctx.fillText(`${Math.round(d)}`,x,h-bottom+6*dpr); }
  ctx.textAlign="right"; ctx.textBaseline="middle";
  for(let k=0;k<=vmax;k+=10){ const y=Y(k); ctx.beginPath(); ctx.moveTo(left-4*dpr,y); ctx.lineTo(left,y); ctx.stroke(); ctx.fillText(`${k}`,left-6*dpr,y); }



ctx.lineWidth=2*dpr; 
  const maxNotch = vehicle?.notches ?? 10;   // ì´ ê°œìˆ˜(0~maxIdx)
  const maxIdx   = maxNotch - 1;  // EB ì¸ë±ìŠ¤
  for(let n=0;n<maxNotch;n++){
    const a=brakeDecels[n]??0; if(a<=0) continue;
    const s=(v0*v0)/(2*a);
    ctx.beginPath(); ctx.strokeStyle = n===lever ? "#ffae00" : "#3fa9ff";
    for(let i=0;i<=100;i++){
      const f=i/100, ds=s*f, v=Math.sqrt(Math.max(0,v0*v0-2*a*ds));
      const x=X(ds), y=Y(v*3.6); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.fillStyle=n===lever?"#ffae00":"#3fa9ff"; ctx.font=`${12*dpr}px 'Orbitron', sans-serif`;
    const tX=X(s); const label = (n===0) ? "N" : (n===maxIdx ? "EB" : `B${n}`);
    ctx.fillText(label, tX+5*dpr, Y(0)+12*dpr);
  }




const xRed=X(remaining); ctx.strokeStyle="#f00"; ctx.lineWidth=1.5*dpr; ctx.beginPath(); ctx.moveTo(xRed,Y(0)); ctx.lineTo(xRed,Y(vmax)); ctx.stroke();
  ctx.fillStyle="#f00"; ctx.font=`${14*dpr}px 'Orbitron', sans-serif`; ctx.textAlign="center"; ctx.fillText("ë‚¨ì€ ê±°ë¦¬", xRed, Y(vmax)-18*dpr);

  const ribbonW=16*dpr, ribbonH=h*.9, ribbonX=w-right-ribbonW-10*dpr+20, ribbonY=((h-ribbonH)/2)-32;
  ctx.fillStyle="rgba(100,100,100,.1)"; ctx.strokeStyle="rgba(100,100,100,.3)"; ctx.lineWidth=1.5*dpr;
  ctx.beginPath(); ctx.rect(ribbonX,ribbonY,ribbonW,ribbonH); ctx.fill(); ctx.stroke();

  const centerY=(ribbonY+ribbonH/2)-14, barH=12*dpr;
  ctx.fillStyle="rgba(60,60,60,.9)"; ctx.fillRect(ribbonX+2*dpr, centerY-barH/2, ribbonW-4*dpr, barH);

  const rem=Math.min(Math.max(st.remaining_m??st.L,-st.L), st.L);
  const diamondW=16*dpr, diamondH=10*dpr, dX=ribbonX+ribbonW/2;
  const normalized=(rem-(-7))/(7-(-7));
  const dY=ribbonY+(ribbonH*(1-normalized))-diamondH/2;
  const adjY=Math.min(Math.max(dY, ribbonY-10*dpr), ribbonY+ribbonH-diamondH+10*dpr);
  ctx.fillStyle="#444"; ctx.strokeStyle="#222"; ctx.lineWidth=2*dpr; ctx.beginPath();
  ctx.moveTo(dX, adjY-diamondH/2); ctx.lineTo(dX+diamondW/2, adjY); ctx.lineTo(dX, adjY+diamondH/2); ctx.lineTo(dX-diamondW/2, adjY);
  ctx.closePath(); ctx.fill(); ctx.stroke();


}



// ë¯¸ë‹ˆ ì¸ë””ì¼€ì´í„° ì‚¬ì´ì¦ˆ ë§ì¶”ê¸°
const ladderCanvas = document.getElementById('brakeLadder');
function sizeLadderCanvas() {
  if (!ladderCanvas) return;
  const dpr = window.devicePixelRatio || 1;
  const cssW = ladderCanvas.clientWidth;
  const cssH = ladderCanvas.clientHeight;
  ladderCanvas.width  = Math.max(1, Math.round(cssW * dpr));
  ladderCanvas.height = Math.max(1, Math.round(cssH * dpr));
}
addEventListener('resize', sizeLadderCanvas);
sizeLadderCanvas();

function drawBrakeLadderMini(st) {
  const ctx2 = ladderCanvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = ladderCanvas.width, h = ladderCanvas.height;
  if (!w || !h) return;
  ctx2.clearRect(0, 0, w, h);

  // â˜… EB ìœ„ì¹˜ëŠ” notch_accels ê¸¸ì´ë¡œ ê²°ì • (ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì´ê²ƒë§Œ ì‹ ë¢°)
  const accArr  = (vehicle && Array.isArray(vehicle.notch_accels)) ? vehicle.notch_accels : null;
  const notches = accArr ? accArr.length
                         : (vehicle && Number.isInteger(vehicle.notches) ? vehicle.notches : 10);

  const ebIdx   = accArr ? Math.max(1, accArr.length - 1)   // 0:N, 1~EB-1:B1.., EB:ë§ˆì§€ë§‰
                         : Math.max(1, notches - 1);

  const blocks  = ebIdx;                   // B1..EB í‘œì‹œ ë¸”ë¡ ìˆ˜
  const cur     = Math.max(0, Math.min(ebIdx, st.lever_notch|0)); // í˜„ì¬ ë…¸ì¹˜ í´ë¨í”„

  // íŒ¨ë„
  ctx2.fillStyle = "rgba(100,100,100,0.10)";
  ctx2.fillRect(0, 0, w, h);

  const pad  = 2 * dpr;
  const gap  = Math.max(2 * dpr, Math.round(h * 0.02));
  const bH   = (h - pad*2 - gap*(blocks-1)) / blocks;
  const bW   = w - pad*2;
  const x    = pad;

  // ì„œë¹„ìŠ¤ ë…¸ì¹˜(ë…¸ë‘): B1..EB-1
  const serviceTop = Math.min(cur, ebIdx - 1);
  for (let k = 1; k <= ebIdx - 1; k++) {
    const i = k - 1;
    const y = h - pad - (i + 1) * bH - i * gap;

    ctx2.fillStyle = "rgba(60,80,100,0.35)";
    ctx2.fillRect(x, y, bW, bH);

    if (k <= serviceTop) {
      ctx2.fillStyle = "#ffd34d";          // ë…¸ë€ìƒ‰
      ctx2.fillRect(x, y, bW, bH);
    }

    ctx2.strokeStyle = "rgba(20,30,45,0.6)";
    ctx2.lineWidth   = 1 * dpr;
    ctx2.strokeRect(x, y, bW, bH);
  }

  // EB(ë§¨ ìœ„)ëŠ” ë¹¨ê°•: cur===EBì¼ ë•Œë§Œ
  const yEB = h - pad - (ebIdx) * bH - (ebIdx - 1) * gap;
  ctx2.fillStyle = "rgba(60,80,100,0.35)";
  ctx2.fillRect(x, yEB, bW, bH);
  if (cur === ebIdx) {
    ctx2.fillStyle = "#ff5757";            // ë¹¨ê°„ìƒ‰
    ctx2.fillRect(x, yEB, bW, bH);
  }
  ctx2.strokeStyle = "rgba(20,30,45,0.6)";
  ctx2.lineWidth   = 1 * dpr;
  ctx2.strokeRect(x, yEB, bW, bH);
}



/* ===== ì „ë™ì°¨/ì‹œë¦¬ì¦ˆ/í¸ì„±: ì‚¬ì§„ ìŠ¤í™ ê³ ì • ===== */
const TRAIN_DB={
  E233:[
    {code:"EAST E233-0", lines:"ì£¼ì˜¤ì¾Œì†Â·ì†Œë¶€ì¾Œì†", file:"./e233_0000.json", lengths:[4,6,10,12]}, // ìš”ì²­ëŒ€ë¡œ
    {code:"EAST E233-1000", lines:"ê²Œì´íŒí† í˜¸ì¿ Â·ë„¤ê¸°ì‹œ", file:"./e233_1000.json", lengths:[10]},
    {code:"EAST E233-2000", lines:"ì¡°ë°˜ ê°ì—­Â·ì¾Œì†", file:"./e233_2000.json", lengths:[10]},
    {code:"EAST E233-3000", lines:"ë„ì¹´ì´ë„Â·ë„í˜¸ì¿ Â·íƒ€ì¹´ì‚¬í‚¤Â·ìš°ì—ë…¸ë„ì¿„/ì†Œë¶€ì¾Œì†Â·ì¡°ë°˜ ì§í†µ", file:"./e233_3000.json", lengths:[5,10,15]},
    {code:"EAST E233-5000", lines:"ê²Œì´ìš”", file:"./e233_5000.json", lengths:[4,6,10]},
    {code:"EAST E233-6000", lines:"ìš”ì½”í•˜ë§ˆ", file:"./e233_6000.json", lengths:[8]},
    {code:"EAST E233-7000", lines:"ì‚¬ì´ì¿„Â·ê°€ì™€ê³ ì—Â·ì‡¼ë‚œì‹ ì£¼ì¿  ì¼ë¶€", file:"./e233_7000.json", lengths:[10]},
    {code:"EAST E233-8000", lines:"ë‚œë¶€", file:"./e233_8000.json", lengths:[6]}
  ],
  E235:[
    {code:"EAST E235-0", lines:"ì•¼ë§ˆë…¸í…Œ", file:"./e235_0.json", lengths:[11]},
    {code:"EAST E235-1000", lines:"ìš”ì½”ìŠ¤ì¹´Â·ì†Œë¶€ì¾Œì†", file:"./e235_1000.json", lengths:[4,11]}
  ]
};

// â–¼ JR-WEST : ë…¸ì„ ëª…ìœ¼ë¡œ êµì²´ (ì‚¬ì‹¤ í™•ì¸ ë°˜ì˜)
TRAIN_DB.JRW223 = [
  // 223-0 (HE ê³„ì—´: íˆë„¤ë…¸ ì†Œì†)
  { code: "WEST 223-0",
    lines: "ì˜¤ì‚¬ì¹´ ìˆœí™˜ì„  Â· í•œì™€ì„  Â· ê°„ì‚¬ì´ê³µí•­ì„  ì§ê²° Â· ê¸°ì„¸ì´ ë³¸ì„ (ê¸°ë…¸ì¿ ë‹ˆì„ , ì™€ì¹´ì•¼ë§ˆâ€“ìŠ¤ì‚¬ë¯¸/ê¸°ì´íƒ€ë‚˜ë² )",
    file: "./223_0000.json", lengths: [4] }, // î¨0î¨‚

  // 223-1000 (V/W í¸ì„±)
  { code: "WEST 223-1000",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½”Â·JR êµí† Â·JR ê³ ë²  ë¼ì¸) Â· ì‚°ìš” ë³¸ì„ (JR ê³ ë²  ë¼ì¸) Â· í˜¸ì¿ ë¦¬ì¿  ë³¸ì„ (ì“°ë£¨ê°€â€“ë§ˆì´ë°”ë¼) Â· ê³ ì„¸ì´ì„  Â· êµ¬ì‚¬ì“°ì„  Â· ì•„ì½”ì„ ",
    file: "./223_1000.json", lengths: [8,4] }, // î¨1î¨‚

  // 223-2000 (W/B/V í¸ì„±)
  { code: "WEST 223-2000",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½”Â·JR êµí† Â·JR ê³ ë²  ë¼ì¸) Â· ì‚°ìš” ë³¸ì„ (JR ê³ ë²  ë¼ì¸) Â· í˜¸ì¿ ë¦¬ì¿  ë³¸ì„ (ì“°ë£¨ê°€â€“ë§ˆì´ë°”ë¼) Â· ê³ ì„¸ì´ì„  Â· êµ¬ì‚¬ì“°ì„  Â· ì•„ì½”ì„ ",
    file: "./223_2000.json", lengths: [8,6,4] }, // î¨2î¨‚

  // 223-2500 (HE: íˆë„¤ë…¸ / RU: êµí†  ë‘ ê³„ì—´ì´ ì¡´ì¬ â†’ ì‚¬ì§„ì— ë§ì¶° 2ê°œë¡œ ë¶„ë¦¬)
  { code: "WEST 223-2500 (Hineno)",
    lines: "ì˜¤ì‚¬ì¹´ ìˆœí™˜ì„  Â· í•œì™€ì„  Â· ê°„ì‚¬ì´ê³µí•­ì„  ì§ê²° Â· ê¸°ì„¸ì´ ë³¸ì„ (ê¸°ë…¸ì¿ ë‹ˆì„ , ì™€ì¹´ì•¼ë§ˆâ€“ìŠ¤ì‚¬ë¯¸/ê¸°ì´íƒ€ë‚˜ë² )",
    file: "./223_2500.json", lengths: [4] }, // î¨3î¨‚
  { code: "WEST 223-2500 (Kyoto)",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½” ë¼ì¸, ì•¼ë§ˆì‹œë‚˜â€“êµí† ) Â· ê³ ì„¸ì´ì„ (ì•¼ë§ˆì‹œë‚˜â€“ë‚˜ê°€í•˜ë¼) Â· ì‚°ì¸ ë³¸ì„ (ì‚¬ê°€ë…¸ì„ , êµí† â€“ê³ ë§ˆ)",
    file: "./223_2500.json", lengths: [4] }, // î¨4î¨‚

  // 223-6000 (PR/MA í¸ì„±: ê°ì† ì œí•œí˜•, ì†Œì†ë³„ ìš´ìš© êµ¬ê°„ ìƒì´)
  { code: "WEST 223-6000",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½”Â·JR êµí† Â·JR ê³ ë²  ë¼ì¸) Â· ì‚°ìš” ë³¸ì„ (JR ê³ ë²  ë¼ì¸) Â· ë°˜íƒ„ì„ (íˆë©”ì§€â€“í…Œë¼ë§ˆì— ì¼ë¶€ ëŒ€ì²´) Â· ì•„ì½”ì„  / (ë¯¸í•˜ë¼ ì†Œì†) JR ê³ ë² ì„ (ì˜¤ì‚¬ì¹´â€“ì•„ë§ˆê°€ì‚¬í‚¤) Â· í›„ì¿ ì¹˜ì•¼ë§ˆì„ (ì•„ë§ˆê°€ì‚¬í‚¤â€“ì‚¬ì‚¬ì•¼ë§ˆêµ¬ì¹˜/í›„ì¿ ì¹˜ì•¼ë§ˆ)",
    file: "./223_6000.json", lengths: [4,6] } // î¨5î¨‚
];

TRAIN_DB.JRW225 = [
  // 225-0 / 100 : ì‹ ì¾Œì† ì¶•
  { code: "WEST 225-0",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½”Â·JR êµí† Â·JR ê³ ë²  ë¼ì¸, ë§ˆì´ë°”ë¼â€“ê³ ë² ) Â· ì‚°ìš” ë³¸ì„ (JR ê³ ë²  ë¼ì¸, ê³ ë² â€“ì¹´ë¯¸ê³ ë¦¬) Â· í˜¸ì¿ ë¦¬ì¿  ë³¸ì„ (ì“°ë£¨ê°€â€“ë§ˆì´ë°”ë¼) Â· ê³ ì„¸ì´ì„  Â· êµ¬ì‚¬ì“°ì„  Â· ì•„ì½”ì„ ",
    file: "./225_0000.json", lengths: [4,8] }, // î¨6î¨‚
  { code: "225-100",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½”Â·JR êµí† Â·JR ê³ ë²  ë¼ì¸, ë§ˆì´ë°”ë¼â€“ê³ ë² ) Â· ì‚°ìš” ë³¸ì„ (JR ê³ ë²  ë¼ì¸, ê³ ë² â€“ì¹´ë¯¸ê³ ë¦¬) Â· í˜¸ì¿ ë¦¬ì¿  ë³¸ì„ (ì“°ë£¨ê°€â€“ë§ˆì´ë°”ë¼) Â· ê³ ì„¸ì´ì„  Â· êµ¬ì‚¬ì“°ì„  Â· ì•„ì½”ì„ ",
    file: "./225_0100.json", lengths: [4,6,8] }, // î¨7î¨‚
  { code: "WEST 225-700",
    lines: "ë„ì¹´ì´ë„ ë³¸ì„ (ë¹„ì™€ì½”Â·JR êµí† Â·JR ê³ ë²  ë¼ì¸, ì•¼ìŠ¤â€“ê³ ë² ) Â· ì‚°ìš” ë³¸ì„ (JR ê³ ë²  ë¼ì¸, ì•„ë³´ì‹œâ€“ê³ ë² )",
    file: "./225_0700.json", lengths: [4] }, // î¨8î¨‚

  // 225-5000/5100 : ê³µí•­Â·í•œì™€Â·ìˆœí™˜ì„  ì¤‘ì‹¬
  { code: "WEST 225-5000",
    lines: "ì˜¤ì‚¬ì¹´ ìˆœí™˜ì„  Â· í•œì™€ì„ (ê°„ì‚¬ì´ê³µí•­ì„  ì§ê²°) Â· ê°„ì‚¬ì´ê³µí•­ì„  Â· ê¸°ì„¸ì´ ë³¸ì„ (ê¸°ë…¸ì¿ ë‹ˆì„ , ì™€ì¹´ì•¼ë§ˆâ€“ê¸°ì´íƒ€ë‚˜ë² )",
    file: "./225_5000.json", lengths: [4] }, // î¨9î¨‚
  { code: "WEST 225-5100 (4ëŸ‰)",
    lines: "ì˜¤ì‚¬ì¹´ ìˆœí™˜ì„  Â· í•œì™€ì„ (ê°„ì‚¬ì´ê³µí•­ì„  ì§ê²°) Â· ê°„ì‚¬ì´ê³µí•­ì„  Â· ê¸°ì„¸ì´ ë³¸ì„ (ê¸°ë…¸ì¿ ë‹ˆì„ , ì™€ì¹´ì•¼ë§ˆâ€“ê¸°ì´íƒ€ë‚˜ë² )",
    file: "./225_5100.json", lengths: [4] }, // î¨10î¨‚
  { code: "WEST 225-5100 (6ëŸ‰)",
    lines: "í•œì™€ì„ ",
    file: "./225_5100.json", lengths: [6] }, // î¨11î¨‚

  // 225-6000 : ì„±ëŠ¥ ì œí•œí˜•(í›„ì¿ ì¹˜ì•¼ë§ˆ ë°©ë©´)
  { code: "WEST 225-6000",
    lines: "JR ê³ ë² ì„ (ì˜¤ì‚¬ì¹´â€“ì•„ë§ˆê°€ì‚¬í‚¤) Â· í›„ì¿ ì¹˜ì•¼ë§ˆì„ (JR íƒ€ì¹´ë¼ì¦ˆì¹´ì„ , ì•„ë§ˆê°€ì‚¬í‚¤â€“ì‚¬ì‚¬ì•¼ë§ˆêµ¬ì¹˜/í›„ì¿ ì¹˜ì•¼ë§ˆ)",
    file: "./225_6000.json", lengths: [6,4] } // î¨12î¨‚
];

TRAIN_DB.JRW323 = [
  { code: "WEST 323-0",
    lines: "ì˜¤ì‚¬ì¹´ ìˆœí™˜ì„  ì „ìš©",
    file: "./323_0000.json", lengths: [8] } // î¨13î¨‚
];

TRAIN_DB.JRW285 = [
  { code: "WEST 285-0/3000",
    lines: "ì¹¨ëŒ€íŠ¹ê¸‰ ì„ ë¼ì´ì¦ˆ ì´ì¦ˆëª¨Â·ì„¸í†  ì „ìš©",
    file: "./285.json",
    lengths: [7, 14] } // 7ëŸ‰í¸ì„±, ë³‘ê²° ì‹œ 14ëŸ‰í¸ì„±
];

TRAIN_DB.JRH261 = [
  { code: "HOKKAIDO KiHa 261-5000",
    lines: "ì¡°ì´í’€ íŠ¸ë ˆì¸ í•˜ë§ˆë‚˜ìŠ¤Â·ë¼ë²¤ë”",
    file: "./261_5000.json",
    lengths: [4, 5, 6, 10] } // 5ëŸ‰ ê¸°ë³¸, 10ëŸ‰ ë³‘ê²°
];

const trainFamilyEl=document.getElementById('trainFamily');
const trainSeriesEl=document.getElementById('trainSeries');
const trainLengthEl=document.getElementById('trainLength');

function setTrainLengthOptions(lengths){
  trainLengthEl.innerHTML="";
  lengths.forEach(len=>{
    const opt=document.createElement('option');
    opt.value=String(len); opt.textContent=`${len}ëŸ‰`;
    trainLengthEl.appendChild(opt);
  });
  updateTrainLength();
}


function loadVehicleFile(filePath){
  fetch(filePath + cacheBust(), { cache: 'no-store' })
    .then(res => res.json())
    .then(data => {
      vehicle = data;
      vehicle.notches = (vehicle.notch_accels || []).length;  // EB ë™ê¸°í™”
      document.getElementById('carName').textContent = vehicle.name;

      brakeDecels = {};
      if (vehicle.notch_accels && vehicle.notches) {
        for (let i = 0; i < vehicle.notches; i++) {
          brakeDecels[i] = Math.abs(vehicle.notch_accels[vehicle.notches - 1 - i] ?? 0);
        }
      }

      // ì„œë²„ vehicle êµì²´
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "cmd", payload: { name: "setVehicleFile", file: filePath } }));
      }

      sendLoadRate();
    })
    .catch(console.error);
}

function populateSeries(){
  const fam=trainFamilyEl.value, list=TRAIN_DB[fam]||[];
  trainSeriesEl.innerHTML="";
  list.forEach((s,i)=>{
    const opt=document.createElement('option');
    opt.value=s.file; opt.dataset.lengths=JSON.stringify(s.lengths);
    opt.textContent=`JR ${s.code} (${s.lines})`;
    if(i===0) opt.selected=true;
    trainSeriesEl.appendChild(opt);
  });
  if(list[0]){ setTrainLengthOptions(list[0].lengths); loadVehicleFile(list[0].file); }
}
trainFamilyEl.addEventListener('change', populateSeries);
trainSeriesEl.addEventListener('change',(e)=>{
  const opt=e.target.selectedOptions[0];
  const lengths=JSON.parse(opt.dataset.lengths||"[]");
  setTrainLengthOptions(lengths);
  loadVehicleFile(opt.value);
});
populateSeries(); // ìµœì´ˆ ì„¸íŒ…
</script>

<footer style="text-align:center; font-size:12px; color:#888; padding:8px 0; user-select:none;">
  Â©2025 Hyungsuk Choi, University of Maryland
</footer>
</body>
</html>
