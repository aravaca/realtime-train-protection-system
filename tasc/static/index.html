<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TASC Simulator</title>
<style>
html, body {
  margin: 0;
  background: radial-gradient(circle at 50% 20%, #0b0f14, #05070a);
  background-attachment: fixed; /* ìŠ¤í¬ë¡¤ ì‹œ ìœ ì§€ */
  color: #e7f0ff;
  font-family: 'Orbitron', system-ui, Segoe UI, Roboto, Apple SD Gothic Neo, AppleGothic, sans-serif;
}

.game-background,
.snow-background,
.rain-background {
  background: transparent !important;
}


#wrap {
  max-width: 960px;
  margin: 18px auto;
  padding: 0 12px;
}

.row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.card {
  background: rgba(18, 24, 38, 0.7);
  border: 1px solid rgba(0, 246, 255, 0.15);
  border-radius: 16px;
  padding: 16px;
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.7);
}

canvas {
  width: 100%;
  height: 320px;
  background: linear-gradient(#0b0f14, #0a1019);
  border-radius: 12px;
}

.kbd {
  background: rgba(10, 18, 28, 0.8);
  border: 1px solid #2b3f5f;
  color: #9fc5ff;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 12px;
}

.stat {
  font-size: 32px;
  font-weight: 800;
  color: #ffffff;
  text-shadow: 0 0 4px rgba(0, 200, 255, 0.8);
}

.ok {
  color: #9effb5;
}
.warn {
  color: #ffd18f;
}
.bad {
  color: #ff9b9b;
}

button, .btn-primary {
  background: linear-gradient(135deg, #00c6ff, #0072ff);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 10px 16px;
  font-size: 15px;
  font-weight: 600;
  transition: background 0.3s ease, transform 0.1s ease;
}
button:hover, .btn-primary:hover {
  background: linear-gradient(135deg, #0072ff, #00c6ff);
  transform: translateY(-1px);
}

#overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  z-index: 9999;
}

#overlay.hide {
  display: none;
}

.overlay-card {
  background: rgba(18, 24, 38, 0.9);
  padding: 24px 28px;
  border-radius: 14px;
  box-shadow: 0 0 20px rgba(0, 246, 255, 0.2);
  text-align: center;
  width: 300px;
  border: 1px solid rgba(0, 246, 255, 0.2);
}

.title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: #00f6ff;
}

.subtitle {
  font-size: 0.9rem;
  color: #9fc5ff;
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 0.85rem;
  margin-bottom: 12px;
  text-align: left;
  font-weight: 500;
  color: #cceaff;
}

.form-input {
  width: 95%;
  padding: 8px 10px;
  font-size: 0.9rem;
  border: 1px solid rgba(0, 246, 255, 0.3);
  border-radius: 8px;
  margin-top: 4px;
  background: rgba(10, 18, 28, 0.6);
  color: #e7f0ff;
}
.form-input:focus {
  border-color: #00f6ff;
  outline: none;
}

.kbd-info {
  margin: 16px 0;
  font-size: 0.85rem;
  color: #9fc5ff;
}

@keyframes neonGlow {
  0%, 100% {
    text-shadow:
      0 0 5px #fff,
      0 0 10px #fff,
      0 0 20px currentColor,
      0 0 30px currentColor,
      0 0 40px currentColor,
      0 0 55px currentColor,
      0 0 75px currentColor;
    opacity: 1;
  }
  50% {
    text-shadow:
      0 0 2px #fff,
      0 0 5px #fff,
      0 0 10px currentColor,
      0 0 15px currentColor,
      0 0 20px currentColor,
      0 0 30px currentColor,
      0 0 40px currentColor;
    opacity: 0.8;
  }
}

.grade-S, .grade-A {
  animation: neonGlow 2s ease-in-out infinite;
}

.grade-S {
  color: gold;
}
.grade-A {
  color: #4CAF50;
}



  /* ëˆˆ ì• ë‹ˆë©”ì´ì…˜ */
  .snowflakes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    overflow:hidden;
  }

  .snowflakes div {
    position: absolute;
    background-color: #fff;
    width: 10px;
    height:10px;
    border-radius: 50%;
    opacity: 0.8;
    animation: snow 5s linear infinite;
  }

  @keyframes snow {
    0% {
      transform: translateY(-20px);
    }
    100% {
      transform: translateY(100vh);
    }
  }

  /* ë¹„ ì• ë‹ˆë©”ì´ì…˜ */
  .raindrops {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9998;
    display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    overflow:hidden;

  }

  .raindrops div {
    position: absolute;
    background-color: rgba(173, 216, 230, 0.8);
    width: 2px;
    height: 15px;
    animation: rain 0.5s linear infinite;
  }

  @keyframes rain {
    0% {
      transform: translateY(-20px);
    }
    100% {
      transform: translateY(100vh);
    }
  }

/* ëˆˆ ë‚´ë¦¬ëŠ” ë°°ê²½ */
.snow-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1; /* ë‹¤ë¥¸ ìš”ì†Œ ì•„ë˜ë¡œ ë°°ì¹˜ */
}

.snow-background .snowflakes {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: block;
}

/* ë¹„ ë‚´ë¦¬ëŠ” ë°°ê²½ */
.rain-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1; /* ë‹¤ë¥¸ ìš”ì†Œ ì•„ë˜ë¡œ ë°°ì¹˜ */
}

.rain-background .raindrops {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: block;
}

/* ê¸°ë³¸ì ìœ¼ë¡œ ë°°ê²½ì— overflow ì„¤ì • */
body {
  overflow: hidden; /* ì• ë‹ˆë©”ì´ì…˜ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì„¤ì • */
}


</style>
</head>
<body>
<div id="wrap" class="row" style="flex-direction:column">
  <div class="row" style="gap:16px;flex-wrap:wrap">
    <div class="card" style="flex:1 1 260px">
      <div id="carName" style="font-size:20px" class = "stat">ì°¨ëŸ‰ ë¡œë”© ì¤‘...</div>
      <div>ë‚¨ì€ ê±°ë¦¬ <span class="stat" id="rem">â€”</span> m</div>
      <div>ì†ë„ <span class="stat" id="spd">â€”</span> km/h</div>
      <div>ë…¸ì¹˜ <span class="stat" id="notch">0.0</span></div>
      <div>êµ¬ë°° <span class="stat" id="grade_percent">â€”</span> %</div>
      <div>ê²½ê³¼ì‹œê°„ <span class="stat" id="timer">0.000</span> s</div>
      <div style="margin-top:8px">ì¡°ì‘: <span class="kbd">Space</span> ì‹œì‘ Â· <span class="kbd">W</span> ë¸Œë ˆì´í¬ ê°•í™”(ë…¸ì¹˜â†‘) Â· <span class="kbd">S</span> ì™„í™”(ë…¸ì¹˜â†“) Â· <span class="kbd">N</span> í•´ë°©</div>
    </div>

    <div class="card" style="flex:2 1 520px">
      <canvas id="hud"></canvas>
    </div>
    <div class="card" style="flex:1 1 240px">
      <div><b>í”¼ë“œë°±</b></div>
      <div id="fb">Spaceë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>
    </div>
  </div>
</div>

<!-- HTML -->
<div id="overlay">
  <div class="card">
    <h2 class="title">ğŸš‰ TASC ê¸°ë°˜ ì •ì°¨ íŠ¸ë ˆì´ë„ˆ</h2>
    <p class="subtitle">ì´ˆê¸°ê°’ì„ ì…ë ¥í•˜ê³  <b>Space</b> ë˜ëŠ” ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>

    <label class="form-label">
      ì´ˆê¸° ì†ë„ (km/h)
      <input id="inputSpeed" type="number" value="90" min="40" max="120" step="10" class="form-input">
    </label>

    <label class="form-label">
      ê±°ë¦¬ (m)
      <input id="inputDist" type="number" value="500" min="200" max="800" step="100" class="form-input">
    </label>

    <label class="form-label">
      ê²½ì‚¬ë„ (%)
      <input id="inputGrade" type="number" value="0.0" min="-10" max="10" step="0.1" class="form-input">
    </label>

    <label class="form-label">
      ë‚ ì”¨
      <select id="weatherSelect" class="form-input">
        <option value="ë§‘ìŒ">ë§‘ìŒ</option>
        <option value="ë¹„ì˜´">ë¹„ì˜´</option>
        <option value="ëˆˆì˜´">ëˆˆì˜´</option>
      </select>
    </label>

    <label class="form-label" for="trainLength">í¸ì„±</label>
      <select class="form-input" id="trainLength" onchange="updateTrainLength()">
        <option value="4">4ëŸ‰ (JR ì†Œë¶€ì„  ì¼ë¶€ êµ¬ê°„)</option>
        <option value="6">6ëŸ‰ (JR ì•¼ë§ˆë…¸í…Œì„ , JR ì¹˜ìš”ë‹¤ì„ , JR ì†Œë¶€ì„ , JR ê²Œì´íŒë„í˜¸ì¿ ì„ )</option>
        <option value="8">8ëŸ‰ (JR ë„í˜¸ì¿ ì„ , JR ìš”ì½”ìŠ¤ì¹´ì„ , JR ì•¼ë§ˆë…¸í…Œì„ , JR ê²Œì´íŒë„í˜¸ì¿ ì„ )</option>
        <option value="10">10ëŸ‰ (JR ë„í˜¸ì¿ ì„  ì¼ë¶€ êµ¬ê°„, JR ì£¼ì˜¤ì„  ì¼ë¶€ êµ¬ê°„)</option>
        <option value="12">12ëŸ‰ (JR ë„í˜¸ì¿ ì„  ì£¼ìš” êµ¬ê°„, JR ì£¼ì˜¤ì„  ì£¼ìš” êµ¬ê°„)</option>
        <option value="15">15ëŸ‰ (JR ë„í˜¸ì¿ ì„  ì¼ë¶€ êµ¬ê°„, ê³ ì† ë…¸ì„ )</option>
      </select>

    <!-- ê²Œì„ ë°°ê²½ -->
    <div class="game-background"></div>

    <!-- ëˆˆ ì• ë‹ˆë©”ì´ì…˜ -->
    <div class="snowflakes"></div>

    <!-- ë¹„ ì• ë‹ˆë©”ì´ì…˜ -->
    <div class="raindrops">
      <div style="animation-delay: 0s; left: 5%;"></div>
      <div style="animation-delay: 0.2s; left: 15%;"></div>
      <div style="animation-delay: 0.4s; left: 25%;"></div>
      <div style="animation-delay: 0.6s; left: 35%;"></div>
      <div style="animation-delay: 0.8s; left: 45%;"></div>
      <div style="animation-delay: 1s; left: 55%;"></div>
      <div style="animation-delay: 1.2s; left: 65%;"></div>
      <div style="animation-delay: 1.4s; left: 75%;"></div>
      <div style="animation-delay: 1.6s; left: 85%;"></div>
      <div style="animation-delay: 1.8s; left: 95%;"></div>

      <!-- ê³„ì† ì¶”ê°€... -->
    </div>

    <!-- ë‹¤ë¥¸ ì½˜í…ì¸ ë“¤... -->


    <div class="kbd-info">
      <span class="kbd">W</span> ë¸Œë ˆì´í¬ ê°•í™” Â· 
      <span class="kbd">S</span> ì™„í™” Â· 
      <span class="kbd">N</span> í•´ë°©
    </div>

    <button id="btnStart" class="btn-primary">Start (Space)</button>
  </div>
</div>


<script>
const snowflakesContainer = document.querySelector('.snowflakes');

// ëˆˆì†¡ì´ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
function generateSnowflake() {
  const snowflake = document.createElement('div');
  const randomLeft = Math.floor(Math.random() * 101);  // Random left position from 0% to 100%
  const animationDelay = Math.random() * 2;  // Random delay before starting (up to 2 seconds)
  const animationDuration = (Math.random() * 5) + 5;  // ëœë¤í•œ ë‚´ë¦¬ê¸° ì†ë„ (5~10ì´ˆ ì‚¬ì´)

  // Set the random left position and animation duration
  snowflake.style.animationDelay = animationDelay + 's';  // Add delay before starting to fall
  snowflake.style.animationDuration = animationDuration + 's';
  snowflake.style.left = randomLeft + '%';

  // Add snowflake styling
  snowflake.style.position = 'absolute';
  snowflake.style.top = '-10px';  // ëˆˆì†¡ì´ ì‹œì‘ ìœ„ì¹˜ (í™”ë©´ ìƒë‹¨)
  snowflake.style.width = '10px';  // ëˆˆì†¡ì´ í¬ê¸°
  snowflake.style.height = '10px';  // ëˆˆì†¡ì´ í¬ê¸°
  snowflake.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';  // í°ìƒ‰
  snowflake.style.borderRadius = '50%';  // ì›í˜•ìœ¼ë¡œ ì„¤ì •

  // Append the snowflake to the container
  snowflakesContainer.appendChild(snowflake);

  // ì¼ì • ì‹œê°„ ë’¤ì— ëˆˆì†¡ì´ê°€ ë–¨ì–´ì§€ì§€ ì•Šë„ë¡ ì‚­ì œ
  setTimeout(() => {
    snowflakesContainer.removeChild(snowflake);
  }, (animationDuration + animationDelay) * 1000);  // ëˆˆì†¡ì´ê°€ ëë‚˜ë©´ ì‚­ì œ
}

// ëˆˆì†¡ì´ë¥¼ ì¼ì • ê°„ê²©ìœ¼ë¡œ ìƒì„±
setInterval(generateSnowflake, 200);  // 200msë§ˆë‹¤ ìƒˆë¡œìš´ ëˆˆì†¡ì´ ìƒì„±

let vehicle = null;
let brakeDecels = {};

fetch('/carName.json')
  .then(res => res.json())
  .then(data => {
    vehicle = data; // vehicleë¡œ ë³€ìˆ˜ëª… í†µì¼
    document.getElementById('carName').textContent = vehicle.name;

    if (vehicle.notch_accels && vehicle.notches) {
      brakeDecels = {};
      for(let i=0; i < vehicle.notches; i++) {
        // ê°ì†ê°’ ë°°ì—´ ë°˜ëŒ€ ìˆœì„œë¡œ ë„£ê¸°
        brakeDecels[i] = Math.abs(vehicle.notch_accels[vehicle.notches - 1 - i] ?? 0);
}

    }
  })
  .catch(console.error);



const ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws");
const remEl=document.getElementById("rem");
const spdEl=document.getElementById("spd");
const notchEl=document.getElementById("notch");
const fb=document.getElementById("fb");
const overlay=document.getElementById("overlay");
const btnStart=document.getElementById("btnStart");
const canvas=document.getElementById("hud");
const ctx=canvas.getContext("2d");

const weatherSelect = document.getElementById("weatherSelect");
const snowflakes = document.querySelector(".snowflakes");
const raindrops = document.querySelector(".raindrops");

weatherSelect.addEventListener("change", function() {
  const weather = this.value;

  if (weather === "ëˆˆì˜´") {
    snowflakes.style.display = "block";  // ëˆˆ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    raindrops.style.display = "none";   // ë¹„ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
  } else if (weather === "ë¹„ì˜´") {
    raindrops.style.display = "block";  // ë¹„ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    snowflakes.style.display = "none";  // ëˆˆ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
  } else {
    raindrops.style.display = "none";   // ë¹„ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
    snowflakes.style.display = "none";  // ëˆˆ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
  }
});

// ì´ˆê¸°ê°’ì— ë”°ë¼ ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •
if (weatherSelect.value === "ëˆˆì˜´") {
  snowflakes.style.display = "block";
  raindrops.style.display = "none";
} else if (weatherSelect.value === "ë¹„ì˜´") {
  snowflakes.style.display = "none";
  raindrops.style.display = "block";
} else {
  snowflakes.style.display = "none";
  raindrops.style.display = "none";
}

function resize(){
  canvas.width=canvas.clientWidth*devicePixelRatio;
  canvas.height=canvas.clientHeight*devicePixelRatio;
}
addEventListener("resize", resize); resize();

function sendCmd(name, delta) {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({type:"cmd", payload:{name, delta}}));
  }
}

function updateTrainLength() {
    const trainLength = document.getElementById("trainLength").value;
    ws.send(JSON.stringify({
        type: "cmd",
        payload: { name: "setTrainLength", length: trainLength }
    }));
}
const inputSpeed = document.getElementById("inputSpeed");
const inputDist = document.getElementById("inputDist");
const inputGrade = document.getElementById("inputGrade");
btnStart.addEventListener("click", () => {
  const speed = Number(inputSpeed.value);
  const dist = Number(inputDist.value);
  const grade = Number(inputGrade.value);

  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: "cmd",
      payload: {
        name: "setInitial",
        speed,
        dist,
        grade,
      }
    }));
  }

  sendCmd("start", 0);
  overlay.classList.add("hide");
});
// ë‚ ì”¨ ë³€ê²½ ì‹œ ì• ë‹ˆë©”ì´ì…˜ê³¼ ë°°ê²½ìƒ‰ì„ ë™ì ìœ¼ë¡œ ë³€ê²½
weatherSelect.addEventListener("change", function() {
  const weather = this.value;

  if (weather === "ëˆˆì˜´") {
    snowflakes.style.display = "block";  // ëˆˆ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    raindrops.style.display = "none";   // ë¹„ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
    document.documentElement.style.background = "#ffffff"; 
    document.body.style.background = "#ffffff"; 
    document.body.classList.add('snow-background');
    document.body.classList.remove('rain-background');
  } else if (weather === "ë¹„ì˜´") {
    raindrops.style.display = "block";  // ë¹„ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    snowflakes.style.display = "none";  // ëˆˆ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
    document.documentElement.style.background = "#4b5d67"; 
    document.body.style.background = "#4b5d67"; 
    document.body.classList.add('rain-background');
    document.body.classList.remove('snow-background');
  } else {
    raindrops.style.display = "none";   // ë¹„ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
    snowflakes.style.display = "none";  // ëˆˆ ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€
    document.documentElement.style.background = "radial-gradient(circle at 50% 20%, #0b0f14, #05070a)"; 
    document.body.style.background = "radial-gradient(circle at 50% 20%, #0b0f14, #05070a)";
    document.body.classList.remove('snow-background');
    document.body.classList.remove('rain-background');
  }
});

// ì´ˆê¸°ê°’ ì„¤ì •
if (weatherSelect.value === "ëˆˆì˜´") {
  snowflakes.style.display = "block";
  raindrops.style.display = "none";
  document.documentElement.style.background = "#ffffff";
  document.body.style.background = "#ffffff"; 
  document.body.classList.add('snow-background');
  document.body.classList.remove('rain-background');
} else if (weatherSelect.value === "ë¹„ì˜´") {
  snowflakes.style.display = "none";
  raindrops.style.display = "block";
  document.documentElement.style.background = "#4b5d67";
  document.body.style.background = "#4b5d67"; 
  document.body.classList.add('rain-background');
  document.body.classList.remove('snow-background');
} else {
  snowflakes.style.display = "none";
  raindrops.style.display = "none";
  document.documentElement.style.background = "#0b0f14"; 
  document.body.style.background = "radial-gradient(circle at 50% 20%, #0b0f14, #05070a)";
  document.body.classList.remove('snow-background');
  document.body.classList.remove('rain-background');
}


btnStart.addEventListener("click", () => {
  const speed = Number(inputSpeed.value);
  const dist = Number(inputDist.value);
  const grade = Number(inputGrade.value);
  const weather = document.getElementById("weatherSelect").value;

  let mu = 1.0;
  if (weather === "ë¹„ì˜´") mu = 0.6;
  else if (weather === "ëˆˆì˜´") mu = 0.3;

  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: "cmd",
      payload: {
        name: "setInitial",
        speed,
        dist,
        grade,
      }
    }));

    ws.send(JSON.stringify({
      type: "cmd",
      payload: {
        name: "setMu",
        value: mu,
      }
    }));
  }

  sendCmd("start", 0);
  overlay.classList.add("hide");
});


addEventListener("keydown", (e) => {
  if ([" ", "w", "W", "s", "S", "n", "N"].includes(e.key)) e.preventDefault();
  if (e.repeat) return;

  if (e.key === " ") {
    if (ws.readyState !== WebSocket.OPEN) return;

    if (overlay.classList.contains("hide")) {
      // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€ ìƒíƒœ â†’ ê²Œì„ ì§„í–‰ ì¤‘ ë˜ëŠ” ì¢…ë£Œ
      if (isFinished) {
        // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë³´ì—¬ì£¼ê¸°
        overlay.classList.remove("hide");
        overlayShowingResult = true;
        isFinished = false; // ê²°ê³¼ì°½ ìƒíƒœ ì§„ì…
      } else {
        // ê²Œì„ ë„ì¤‘ì— ë‹¤ì‹œ ì‹œì‘
        const speed = Number(inputSpeed.value);
        const dist = Number(inputDist.value);
        const grade = Number(inputGrade.value);
        ws.send(JSON.stringify({
          type: "cmd",
          payload: {
            name: "setInitial",
            speed,
            dist,
            grade,
          }
        }));
        ws.send(JSON.stringify({
          type: "cmd",
          payload: { name: "start" }
        }));
        isFinished = false;
        overlayShowingResult = false;
      }
    } else {
      // ì˜¤ë²„ë ˆì´ê°€ ë³´ì´ëŠ” ìƒíƒœ â†’ ê²Œì„ ì‹œì‘
      overlay.classList.add("hide");
      const speed = Number(inputSpeed.value);
      const dist = Number(inputDist.value);
      const grade = Number(inputGrade.value);
      ws.send(JSON.stringify({
        type: "cmd",
        payload: {
          name: "setInitial",
          speed,
          dist,
          grade,
        }
      }));
      ws.send(JSON.stringify({
        type: "cmd",
        payload: { name: "start" }
      }));
      isFinished = false;
      overlayShowingResult = false;
    }
  } 
  else if (e.key === "w" || e.key === "W") {
    sendCmd("applyNotch", +1);
  }
  else if (e.key === "s" || e.key === "S") {
    sendCmd("applyNotch", -1);
  }
  else if (e.key === "n" || e.key === "N") {
    sendCmd("release", 0);
  }
});


if (/Mobi|Android/i.test(navigator.userAgent)) {
  window.addEventListener("touchstart", (e) => {
    if (e.touches.length !== 1) return;  // í•œ ì†ê°€ë½ë§Œ í„°ì¹˜ë˜ì—ˆì„ ë•Œë§Œ ì²˜ë¦¬
    const touch = e.touches[0];
    const y = touch.clientY;  // í„°ì¹˜í•œ Yì¢Œí‘œ
    const h = window.innerHeight;  // í™”ë©´ ë†’ì´

    // í™”ë©´ ìƒë‹¨ì„ í„°ì¹˜í–ˆì„ ë•Œ
    if (y < h / 2) {
      sendCmd("applyNotch", +1);  // ë¸Œë ˆì´í¬ ì˜¬ë¦¬ê¸°
      e.preventDefault();  // í„°ì¹˜ ì´ë²¤íŠ¸ì˜ ê¸°ë³¸ ë™ì‘ì„ ë§‰ìŒ
    }
    // í™”ë©´ í•˜ë‹¨ì„ í„°ì¹˜í–ˆì„ ë•Œ
    else {
      sendCmd("applyNotch", -1);  // ë¸Œë ˆì´í¬ ë‚´ë¦¬ê¸°
      e.preventDefault();  // í„°ì¹˜ ì´ë²¤íŠ¸ì˜ ê¸°ë³¸ ë™ì‘ì„ ë§‰ìŒ
    }
  }, { passive: false });
}

let prevMaxDistance = 0;



// HUD ê·¸ë¦¬ê¸°
function drawHUD(st) {
  const dpr = devicePixelRatio || 1, w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const v0 = st.v;
  const lever = st.lever_notch;
  const currentPos = st.pos ?? 0;
  const stopPos = st.stopPos ?? 500;

  const remainingDistance = (typeof st.remaining_m === "number") ? Math.max(0, st.remaining_m) : Math.max(0, stopPos - currentPos);


  const minL = 1;
  const maxDecel = Math.max(...Object.values(brakeDecels));
  const maxStopDist = maxDecel > 0 ? (v0 * v0) / (2 * maxDecel) : 0;

  const speedFactor = Math.max(0.3, Math.min(1, v0 / 10)); 

  const adjustedRemaining = remainingDistance * (1 + (1 - speedFactor) * 0.5);

  // ì¶•ì†Œ ë°©ì§€ìš© ìµœì†Œ ê±°ë¦¬ ê¸°ì¤€
  const minX = 1; // 50m ì´í•˜ë¡œ ì¶•ì†Œ ë°©ì§€

  // remainingDistanceê°€ ì‘ì„ ë•Œ ê¸‰ê²©í•œ ì¶•ì†Œ ë°©ì§€ (ì˜ˆ: ì œê³±ê·¼ ìŠ¤ì¼€ì¼ë§)
  const safeRemaining = Math.max(minX, Math.sqrt(adjustedRemaining) * 10);
  const s_b1 = (brakeDecels[1] ?? 0) > 0 ? (v0 * v0) / (2 * brakeDecels[1]) : 0;
  const s_b2 = (brakeDecels[2] ?? 0) > 0 ? (v0 * v0) / (2 * brakeDecels[2]) : 0;



  const isStart = remainingDistance > 0;  // ì‹œì‘ ê¸°ì¤€, í•„ìš”í•˜ë©´ ì¡°ì ˆ


  const smoothFactor = 0.1;  // 0~1, í´ìˆ˜ë¡ ë¹ ë¥´ê²Œ ë³€í™”
  const targetMaxDistance = Math.max(
    minL,
    maxStopDist * 1.5,          // ìµœëŒ€ ì œë™ ê±°ë¦¬ ê¸°ì¤€
    safeRemaining * 1.2,        // ë‚¨ì€ ê±°ë¦¬ ê¸°ì¤€
    s_b1 * 1.1,                 // B1 í‘œì‹œë„ ë“¤ì–´ì˜¤ê²Œ
    s_b2 * 1.1                  // B2 í‘œì‹œë„ ë“¤ì–´ì˜¤ê²Œ
  );

  let maxDistance;

  if (prevMaxDistance === 0) {
    // ì²« í”„ë ˆì„ â†’ ë¶€ë“œëŸ¬ìš´ ë³´ê°„ ì—†ì´ ë°”ë¡œ íƒ€ê²Ÿ ê±°ë¦¬ ì‚¬ìš©
    maxDistance = targetMaxDistance;
  } else {
    // ì´í›„ í”„ë ˆì„ â†’ ë¶€ë“œëŸ¬ìš´ ë³´ê°„
    maxDistance = prevMaxDistance * (1 - smoothFactor) + targetMaxDistance * smoothFactor;
  }

  prevMaxDistance = maxDistance;


  const leftMargin = 48 * dpr;
  const rightMargin = 12 * dpr;
  const usableWidth = w - leftMargin - rightMargin;
  const X = dist => leftMargin + usableWidth * (dist / maxDistance);

  const vmax = Math.max(1, v0 * 3.6 * 1.2);

  const bottomMargin = 28 * dpr;
  const topMargin = 12 * dpr;
  const usableHeight = h - bottomMargin - topMargin;
  const Y = v => h - bottomMargin - usableHeight * (v / vmax);

  // ì¶• ê·¸ë¦¬ê¸°
  ctx.strokeStyle = "#20334d";
  ctx.lineWidth = 1 * dpr;
  ctx.beginPath();
  ctx.moveTo(leftMargin, topMargin);
  ctx.lineTo(leftMargin, h - bottomMargin);
  ctx.lineTo(w - rightMargin, h - bottomMargin);
  ctx.stroke();

  // xì¶• ëˆˆê¸ˆ (50m ë‹¨ìœ„)
  ctx.fillStyle = "#888";
  ctx.font = `${10 * dpr}px sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  for (let dist = 0; dist <= maxDistance; dist += 100) {
    const x = X(dist);
    ctx.beginPath();
    ctx.moveTo(x, h - bottomMargin);
    ctx.lineTo(x, h - bottomMargin + 4 * dpr);
    ctx.stroke();
    ctx.fillText(`${Math.round(dist)}`, x, h - bottomMargin + 6 * dpr);
  }

  // yì¶• ëˆˆê¸ˆ (10km/h ë‹¨ìœ„)
  ctx.textAlign = "right";
  ctx.textBaseline = "middle";
  for (let speed_kmh = 0; speed_kmh <= vmax; speed_kmh += 10) {
    const y = Y(speed_kmh);
    ctx.beginPath();
    ctx.moveTo(leftMargin - 4 * dpr, y);
    ctx.lineTo(leftMargin, y);
    ctx.stroke();
    ctx.fillText(`${speed_kmh}`, leftMargin - 6 * dpr, y);
  }

  // ë¸Œë ˆì´í¬ ë‹¨ê³„ë³„ ê°ì† ê³¡ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 2 * dpr;
  const maxNotch = vehicle?.notches ?? 9;
  for(let notch = 0; notch < maxNotch; notch++) {
    const decel = brakeDecels[notch] ?? 0;
    if(decel <= 0) continue;

    const s_brake = (v0 * v0) / (2 * decel);

    ctx.beginPath();
    ctx.strokeStyle = notch === lever ? "#ffae00" : "#3fa9ff";

    for(let i=0; i<=100; i++) {
      const frac = i / 100;
      const s = s_brake * frac;
      const v_cur = Math.sqrt(Math.max(0, v0*v0 - 2*decel*s));
      const x = X(s);
      const y = Y(v_cur * 3.6);

      if(i===0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();

    ctx.fillStyle = notch === lever ? "#ffae00" : "#3fa9ff";
    ctx.font = `${12 * dpr}px 'Orbitron', sans-serif`;
    const textX = X(s_brake);
    if (notch == 8) {
      ctx.fillText(`EB`, textX + 5 * dpr, Y(0) + 12 * dpr);
      
    } else if (notch == 0) {
      ctx.fillText(`N`, textX + 5 * dpr, Y(0) + 12 * dpr);
      
    } else{
      ctx.fillText(`B${notch}`, textX + 5 * dpr, Y(0) + 12 * dpr);
    }
  }



  // ë¹¨ê°„ ì„¸ë¡œì„ : ë‚¨ì€ ê±°ë¦¬ ìœ„ì¹˜
  const x_redline = X(remainingDistance);
  ctx.strokeStyle = "#ff0000";
  ctx.lineWidth = 1.5 * dpr;
  ctx.beginPath();
  ctx.moveTo(x_redline, Y(0));
  ctx.lineTo(x_redline, Y(vmax));
  ctx.stroke();

  ctx.fillStyle = "#ff0000";
  ctx.font = `${14 * dpr}px 'Orbitron', sans-serif`;
  ctx.textAlign = "center";
  ctx.fillText("ë‚¨ì€ ê±°ë¦¬", x_redline, Y(vmax) - 18 * dpr);

  // // í˜„ì¬ ì†ë„ ì  í‘œì‹œ (ë¹¨ê°„ì„  ìœ„)
  // ctx.fillStyle = "#ffd18f";
  // ctx.beginPath();
  // ctx.arc(x_redline, Y(v0 * 3.6), 6 * dpr, 0, 2 * Math.PI);
  // ctx.fill();

  // // í˜„ì¬ ì†ë„ í…ìŠ¤íŠ¸ (ë¹¨ê°„ì„  ì˜¤ë¥¸ìª½ ìœ„)
  // ctx.fillStyle = "#ffd18f";
  // ctx.font = `${14 * dpr}px 'Orbitron', sans-serif`;
  // ctx.textAlign = "left";
  // ctx.fillText(`ì†ë„: ${(v0 * 3.6).toFixed(1)} km/h`, x_redline + 10 * dpr, Y(v0 * 3.6) - 10 * dpr);

// ë¦¬ë³¸ ë„ˆë¹„, ë†’ì´, ìœ„ì¹˜
const ribbonWidth = 16 * dpr;
const ribbonHeight = h * 0.9;
const ribbonX = w - rightMargin - ribbonWidth - 10 * dpr + 20;
const ribbonY = ((h - ribbonHeight) / 2) - 12;

// ë¦¬ë³¸ ê·¸ë¦¬ê¸°
ctx.fillStyle = "rgba(100, 100, 100, 0.1)";
ctx.strokeStyle = "rgba(100, 100, 100, 0.3)";
ctx.lineWidth = 1.5 * dpr;
ctx.beginPath();
ctx.rect(ribbonX, ribbonY, ribbonWidth, ribbonHeight);
ctx.fill();
ctx.stroke();

// ë¦¬ë³¸ ì¤‘ì•™ ê¸°ì¤€ì  (0m) í‘œì‹œìš© ì‘ì€ ì§„í•œ íšŒìƒ‰ ë°•ìŠ¤
const centerY = (ribbonY + ribbonHeight / 2) - 5;
const barHeight = 12 * dpr;
ctx.fillStyle = "rgba(60, 60, 60, 0.9)";
ctx.fillRect(ribbonX + 2 * dpr, centerY - barHeight / 2, ribbonWidth - 4 * dpr, barHeight);

// ë‹¤ì´ì•„ëª¬ë“œê°€ ì›€ì§ì¼ ìµœëŒ€ í”½ì…€ í­ (ì„¸ë¡œ ë°©í–¥)
const ribbonTotalHeight = ribbonHeight; // ë¦¬ë³¸ì˜ ë†’ì´

// ìœ ì € ì…ë ¥ ì •ì°¨ ê±°ë¦¬ L (m)
const L = st.L;

// í˜„ì¬ ë‚¨ì€ ê±°ë¦¬ (m), 0~L ë²”ìœ„ ì œí•œ
const rem = Math.min(Math.max(st.remaining_m ?? L, -L), L); // rem ê°’ì´ -L ~ L ë²”ìœ„ë¡œ ì œí•œ

// ë¦¬ë³¸ì˜ ìƒë‹¨ì„ 5m, í•˜ë‹¨ì„ -5më¡œ ì„¤ì •
const topLimit = 7;    // ë¦¬ë³¸ ìƒë‹¨ (5m)
const bottomLimit = -7; // ë¦¬ë³¸ í•˜ë‹¨ (-5m)

// ë‹¤ì´ì•„ëª¬ë“œì˜ ì„¸ë¡œ ìœ„ì¹˜ ê³„ì‚°
// rem=0ì¼ ë•Œ ë¦¬ë³¸ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ê³ ,
// rem=5ì¼ ë•Œ ë¦¬ë³¸ ìƒë‹¨ì— ìœ„ì¹˜í•˜ë©°,
// rem=-5ì¼ ë•Œ ë¦¬ë³¸ í•˜ë‹¨ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì •
const diamondWidth = 16 * dpr;
const diamondHeight = 10 * dpr;

const stopErrorRaw = st.stop_error_m ?? 0;
const stopErrorM = Math.max(-5, Math.min(5, stopErrorRaw));

// ë‹¤ì´ì•„ëª¬ë“œ X ì¢Œí‘œëŠ” ê³ ì •
const diamondX = ribbonX + ribbonWidth / 2;

// ë‚¨ì€ ê±°ë¦¬ remì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ì´ì•„ëª¬ë“œì˜ Y ì¢Œí‘œ ê³„ì‚°
// rem=0ì¼ ë•Œ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ê³ , rem=5ì¼ ë•Œ ìƒë‹¨, rem=-5ì¼ ë•Œ í•˜ë‹¨ì— ìœ„ì¹˜í•˜ë„ë¡ ê³„ì‚°
const normalizedRem = (rem - bottomLimit) / (topLimit - bottomLimit); // -5 ~ 5 ë²”ìœ„ -> 0 ~ 1 ë²”ìœ„ë¡œ ë³€í™˜

// ë‹¤ì´ì•„ëª¬ë“œ Y ì¢Œí‘œ ê³„ì‚° (0ì¼ ë•Œ ì¤‘ì•™, 5ì¼ ë•Œ ìƒë‹¨, -5ì¼ ë•Œ í•˜ë‹¨)
// ì˜¤ë²„ëŸ°ì„ í—ˆìš©í•˜ë ¤ë©´ normalizedRem ê³„ì‚°ì„ ì¼ë¶€ ì¡°ì •
const diamondY = ribbonY + (ribbonHeight * (1 - normalizedRem)) - diamondHeight / 2;

// ì˜¤ë²„ëŸ°ë„ í‘œì‹œí•˜ë„ë¡ ë‹¤ì´ì•„ëª¬ë“œê°€ ë¦¬ë³¸ì˜ ìƒë‹¨ ë° í•˜ë‹¨ì„ ë²—ì–´ë‚  ìˆ˜ ìˆë„ë¡ ì¶”ê°€
const overflowLimit = 10 * dpr; // ì˜¤ë²„ëŸ°ì„ í‘œí˜„í•  ìˆ˜ ìˆëŠ” í•œê³„

// ë‹¤ì´ì•„ëª¬ë“œê°€ ë¦¬ë³¸ì„ ë„˜ì–´ì„œ ì˜¤ë²„ëŸ° í•  ìˆ˜ ìˆë„ë¡ Y ê°’ì„ ì¡°ì •
const adjustedDiamondY = Math.min(Math.max(diamondY, ribbonY - overflowLimit), ribbonY + ribbonHeight - diamondHeight + overflowLimit);

ctx.fillStyle = "#444";
ctx.strokeStyle = "#222";
ctx.lineWidth = 2 * dpr;

ctx.beginPath();
ctx.moveTo(diamondX, adjustedDiamondY - diamondHeight / 2);
ctx.lineTo(diamondX + diamondWidth / 2, adjustedDiamondY);
ctx.lineTo(diamondX, adjustedDiamondY + diamondHeight / 2);
ctx.lineTo(diamondX - diamondWidth / 2, adjustedDiamondY);
ctx.closePath();
ctx.fill();
ctx.stroke();

}

// ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ (ì´ˆë‹¹ 60fps)
let lastTimestamp = 0;
function loop(timestamp) {
  if (!lastTimestamp) lastTimestamp = timestamp;
  const dt = (timestamp - lastTimestamp) / 1000;
  lastTimestamp = timestamp;

  // updateSimulation(dt);
  if (st) drawHUD(st);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

const grade_percentEl = document.getElementById("grade_percent");
const timerEl = document.getElementById("timer");

let isFinished = false;  // ì •ì§€ ì™„ë£Œ ì—¬ë¶€ ì „ì—­ ë³€ìˆ˜
let overlayShowingResult = false;  // ì •ì§€ ì™„ë£Œ ì—¬ë¶€ ì „ì—­ ë³€ìˆ˜
let st = null;
ws.onmessage = (ev) => {
  const msg = JSON.parse(ev.data);
  if (msg.type === "state") {
    st = msg.payload;

    // ë‚¨ì€ ê±°ë¦¬ ìˆ«ì íƒ€ì… ë³´ì¥
    const remRaw = st.remaining_m;
    const rem = typeof remRaw === "number" ? remRaw : parseFloat(remRaw);

    remEl.textContent = rem >= 0
      ? rem.toFixed(2)
      : `-${Math.abs(rem).toFixed(2)}`;

    spdEl.textContent = (st.v * 3.6).toFixed(1);
    function notchText(notch) {
      if (notch === 0) return "N";
      else if (notch === 8) return "EB"; 
      else return `B${notch}`;
    }
    notchEl.textContent = notchText(st.lever_notch);

    grade_percentEl.textContent = st.grade_percent.toFixed(2);
    timerEl.textContent = st.t.toFixed(3);
    drawHUD(st);

    if (st.finished) {
      isFinished = true;
      const issues = st.issues || {};

      const feedbackItems = [
        { key: "early_brake_too_short", goodText: "ì´ˆê¸° ì œë™ì„ ìˆ˜í–‰í•¨ - ìŠ¹ì°¨ê° ì–‘í˜¸", badText: "ì´ˆê¸° ì œë™ì„ ê²Œì„ë¦¬í•¨ - ìŠ¹ì°¨ê° ë¶ˆì¾Œ" },
        {
          key: "stop_not_b1",
          goodText: "ì •ì°¨ ì‹œ B1ë¡œ ì •ì°¨í•¨ - ìŠ¹ì°¨ê° ì–‘í˜¸",
          badTextFunc: (issues) => issues.stop_not_b1_msg || "ì •ì°¨ ì‹œ B1ë¡œ ì •ì°¨í•˜ì§€ ì•ŠìŒ",
        },
        {
          key: "step_brake_incomplete",
          goodText: "ê¸°ë³¸ì œë™ (ê³„ë‹¨ì œë™/ì™„í•´) ìˆ˜í–‰í•¨",
          badTextFunc: (issues) => {
            const overrun = issues.stop_error_m !== undefined && issues.stop_error_m <= -2;
            if (issues.stop_error_m !== undefined && issues.stop_error_m <= -2) {
              return "ê¸°ë³¸ì œë™ (ê³„ë‹¨ì œë™/ì™„í•´) ë¯¸í¡ - ì˜¤ë²„ëŸ°";
            }
            return "ê¸°ë³¸ì œë™ (ê³„ë‹¨ì œë™/ì™„í•´) ë¯¸í¡ - ë‹¨ì†ì ì¸ ì œë™ìœ¼ë¡œ ì¸í•œ ìŠ¹ê° ì ë¦¼ ë° ì°¨ëŸ‰ ì§„ë™ ë°œìƒ";
          },
        },
        { key: "unnecessary_eb_usage", goodText: "ì˜ì—… ì•ˆì „ ì œë™ë²”ìœ„ ì¤€ìˆ˜", badText: "ë¶ˆí•„ìš”í•œ ë¹„ìƒì œë™(EB) ì‚¬ìš© - ê¸‰ê°ì†ìœ¼ë¡œ ì¸í•œ ì¶©ê²© ë°œìƒ" },
      ];

      // ì¤‘ë³µ ì œê±°: feedbacksë¥¼ í•œ ë²ˆë§Œ ë§Œë“­ë‹ˆë‹¤
      const feedbacks = feedbackItems.map(item => {
        const bad = issues[item.key];
        if (!bad) {
          return { text: item.goodText, isGood: true };
        } else {
          const badText = item.badTextFunc ? item.badTextFunc(issues) : item.badText;
          return { text: badText, isGood: false, isBad: true };
        }
      });

      const isStopErrorGood = Math.abs(st.stop_error_m || 0) <= 2;

      feedbacks.push({
        text: `ì •ì§€ ì˜¤ì°¨: ${st.stop_error_m.toFixed(2)} m`,
        isGood: isStopErrorGood,
      });

      feedbacks.push({
        text: `ìµœì¢… ì ìˆ˜: ${st.score}ì `,
        isGood: isStopErrorGood,
      });

    
      fb.innerHTML = feedbacks
        .map(item => {
          if (item.isBad) {
            return `<div class="bad">${item.text}</div>`;
          }
          return `<div class="${item.isGood ? "ok" : "warn"}">${item.text}</div>`;
        })
        .join("") + `<div style="margin-top:8px;font-size:12px;color:#a6b7d1">Spaceë¡œ ë‹¤ì‹œ ì‹œì‘ Â· N í•´ë°© Â· W/Së¡œ ì¡°ì‘</div>`;

    } else {
      isFinished = true;
      fb.textContent = "Spaceë¡œ ì‹œì‘. W/Së¡œ ë¸Œë ˆì´í¬ ì¡°ì ˆí•˜ì„¸ìš”.";
    }

  }
};


</script>
</body>
</html>

